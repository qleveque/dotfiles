#!/usr/bin/zsh
configDir="${0:h}"

# theme
colors_string="171127-231b37-2d3457-444e88"
NVIM_THEME="${HOME}/.config/nvim/colors/theme.vim"
NVIM_TMUX="${HOME}/.theme.tmux"
NVIM_VIFM="${HOME}/.theme.vifm"
COLORS=("${(s:-:)colors_string}")
mkdir -p `dirname ${NVIM_THEME}`

:> ${NVIM_TMUX} :> ${NVIM_THEME}
for (( i=1; i<=${#COLORS[@]}; i++ )); do
    echo "let PALETTE_${i}=\"#${COLORS[$i]}\"" >> ${NVIM_THEME}
    echo "PALETTE_${i}=#${COLORS[$i]}" >> ${NVIM_TMUX}
done
cat "${configDir}/theme/vim" >> ${NVIM_THEME}
cat "${configDir}/theme/tmux" >> ${NVIM_TMUX}
ln -f "${configDir}/theme/vifm" ${NVIM_VIFM}

# dotfiles
python3 "${configDir}/dotfiles/lesskey.py" > ~/.lesskey
ln -f "${configDir}/dotfiles/.gitconfig" "${HOME}/"

if iswsl; then
  appData="${HOME}/AppData/Roaming"
  # VSCode
  codeDir="${appData}/Code/User"
  if [[ -d ${codeDir} ]]; then
    ln -f "${configDir}/VSCode/settings.json" "${codeDir}/settings.json"
    ln -f "${configDir}/VSCode/keybindings.json" "${codeDir}/keybindings.json"
  fi
  # JetBrains
  ln -f "${configDir}/JetBrains/.ideavimrc" "${HOME}/_ideavimrc"
  for dirPattern in 'PyCharm*' 'IdeaIC*'; do
    dir=$(find "${appData}/JetBrains" -type d -name $dirPattern|sort -n|tail -n1)
    if [[ -d ${dir} ]]; then
      mkdir -p "${dir}/keymaps"
      ln -f "${configDir}/JetBrains/keybindings.xml" "${dir}/keymaps/keybindings.xml"
    fi
  done
  # Git
  ln -f "${configDir}/wsl/wslgit" "${HOME}/bin/git"
  chmod +x "${HOME}/bin/git"
fi
