# Base
setopt histignorealldups sharehistory
setopt +o nomatch
stty -ixon
HISTSIZE=1000
SAVEHIST=1000
HISTFILE=~/.zsh_history

PROMPT='%B%K{black}%F{cyan}%S%T%s%f%k%b %B%F{blue}%3~%f%b %# '
export LANG=en_US.UTF-8
export SHELL='/usr/bin/zsh'
export EDITOR='/usr/bin/nvim'
export LESS='-ir'
export LS_COLORS='ow=30;42'

# Run all program files
run(){
    ext=$1:t:e
    case "$ext" in
        py) python3 $@;;
        js) node $@;;
        cc|cpp) g++ $@ && ./a.out;;
        c) gcc $@ && ./a.out;;
        rs) rustc $@ -o a.out && ./a.out;;
        kt) kotlinc $@ -include-runtime -d a.jar && java -jar a.jar;;
        java) javac $@ && java -cp . $(echo "$@" | cut -f 1 -d '.');;
        go) go run $@;;
        sh|bash|zsh) zsh $@;;
        *) echo "Nothing to do";;
        esac
}

# Open function
if grep -q Microsoft /proc/version; then
open(){
    if [[ -n "$@" ]]
        then
            /mnt/c/Windows/System32/cmd.exe /C start "" "$@"
            fi
}
else
open(){
    xdg-open $1 1>/dev/null 2>/dev/null &
}
fi

# Aliases
alias e='nvim'
alias vim='nvim'
alias c='source c'
alias ls='ls --color=auto'
alias telnet='telnet -e ^C'
alias fd='fd -I --hidden'
alias rg='rg --smart-case'
alias q='qalc'
alias meteo='curl wttr.in/lausanne'
alias parrot='curl parrot.live'

alias gs='git status'
alias gsu='git status -uno'
alias ga='git add'
alias gau='git add -u'
alias gw='git switch'
alias gr='git restore'
alias grs='git restore --staged'
alias gca='git commit --amend'
alias gcan='git commit --amend --no-edit'
alias gcp='git cherry-pick'
alias gcpc='git cherry-pick --continue'
alias gcpa='git cherry-pick --abort'
alias grc='git rebase --continue'
alias gra='git rebase --abort'
alias gri='git rebase -i'
alias gg='git graph -n15'
alias grlc='git rev-list --count'
alias gdt='git diff-tree -r'

# Pyqo
ef(){
    nvim `f $1 -e`
}

# Zsh vim mode
MODE_INDICATOR=""
KEYTIMEOUT=20
source ~/.zsh/plugins/zsh-vim-mode/zsh-vim-mode.plugin.zsh
source ~/.zsh/plugins/zsh-system-clipboard/zsh-system-clipboard.zsh
source ~/.zsh/plugins/fzf-tab-completion/zsh/fzf-zsh-completion.sh
bindkey '^I' fzf_completion
setopt NO_prompt_subst
VIM_MODE_TRACK_KEYMAP=no
MODE_CURSOR_VIINS="#00ff00 blinking bar"
MODE_CURSOR_REPLACE="$MODE_CURSOR_VIINS #ff0000"
MODE_CURSOR_VICMD="green block"
MODE_CURSOR_SEARCH="#ff00ff steady underline"
MODE_CURSOR_VISUAL="$MODE_CURSOR_VICMD steady bar"
MODE_CURSOR_VLINE="$MODE_CURSOR_VISUAL #00ffff"
typeset -g ZSH_SYSTEM_CLIPBOARD_TMUX_SUPPORT='true'

# Theme
theme(){
    sed -i "\$s/.*/colors: \\*$1/" ~/.config/alacritty/alacritty.yml
    sed -i "1s/.*/set bg=$1/" ~/.vim/style.vim
}

# Vifm
vifm-only-choose-dir()
{
    local dst=$(vifm -c :only --choose-dir - . < /dev/tty)
    if [ -z "$dst" ]; then
        echo 'Directory picking cancelled/failed'
        return 1
    fi
    cd "$dst"
    zle reset-prompt
    vim-mode-set-cursor-style viins
    return 0
}
zle -N wvf vifm-only-choose-dir
bindkey "^f" wvf

# FZF
export FZF_DEFAULT_COMMAND="fd -I --hidden"
export FZF_CTRL_T_COMMAND="fd -I --hidden"
export FZF_ALT_C_COMMAND="fd --type d -I --hidden"
export FZF_DEFAULT_OPTS="--ansi --height 40% --border"
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh
[ -f /usr/share/doc/fzf/examples/key-bindings.zsh ] && source /usr/share/doc/fzf/examples/key-bindings.zsh

# Exit
exit_zsh() { exit }
zle -N exit_zsh
bindkey '^Q' exit_zsh
bindkey -M vicmd '^Q' exit_zsh

# Windows
if grep -q Microsoft /proc/version; then
    export DISPLAY=:0.0
    cmd(){
        cmd.exe /C $@
    }
    for filename in ~/bin/*.bat; do
        leaf=$(basename $filename)
        com=${leaf%.*}
        repl="cmd.exe /C %HOME%/bin/${com}.bat"
        alias "$com=$repl"
    done
    unset leaf; unset com; unset repl
fi
